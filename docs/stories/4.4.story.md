# 4.4: Dashboard Comercial (Sales Pipeline)

**Status:** Ready
**Sprint:** 6
**Points:** 8
**Epic:** EPIC-004

---

## User Story

**Como** sales manager
**Quero** visualizar meu pipeline de vendas com leads em diferentes estágios
**Para que** eu acompanhe o progresso comercial e identifique gargalos

---

## Description

Implementar dashboard comercial com pipeline visual (5 estágios) onde:
- Leads podem ser arrastados entre estágios
- Cada estágio mostra valor total
- Taxa de conversão calculada automaticamente
- Meta vs Realizado com progress bar
- Mock data com 20+ leads

---

## Acceptance Criteria

### AC-404.1: Pipeline Visual com 5 estágios
- [ ] Prospecção → Qualificação → Proposta → Negociação → Fechado
- [ ] Cada coluna mostra quantidade de leads
- [ ] Cada coluna mostra valor total
- [ ] Cores por estágio (padrão: azul)

### AC-404.2: Drag & Drop de Leads
- [ ] Lead card pode ser arrastado entre estágios
- [ ] Drop atualiza estágio do lead
- [ ] Animação visual durante drag
- [ ] Feedback visual de drop zone
- [ ] Undo para últimas ações (ou refresh)

### AC-404.3: Lead Cards
- [ ] Nome do cliente
- [ ] Empresa
- [ ] Valor
- [ ] Data do contato
- [ ] Probability %
- [ ] Clique expande detalhes

### AC-404.4: Valor Total por Estágio
- [ ] Soma de leads no estágio
- [ ] Atualiza em tempo real ao drag
- [ ] Formato: R$ XX.XXX,XX

### AC-404.5: Taxa de Conversão
- [ ] Card mostra: "Conversão: 45%" (leads que avançam / total)
- [ ] Calculado de forma simples
- [ ] Atualiza conforme leads se movem

### AC-404.6: Meta vs Realizado
- [ ] Progress bar: Meta: R$ 50.000 | Realizado: R$ 32.500 (65%)
- [ ] Percentual visual + numérico
- [ ] Cor verde se acima de 80%, amarela 50-80%, vermelha < 50%

### AC-404.7: Adicionar Novo Lead
- [ ] Botão "+ Novo Lead"
- [ ] Form popup: nome, empresa, email, valor, probabilidade
- [ ] Salva no estado
- [ ] Novo lead aparece em "Prospecção"

### AC-404.8: Detalhes do Lead
- [ ] Clique em card expande/modal
- [ ] Mostra: nome, empresa, email, telefone, valor, data, notas
- [ ] Editar notas (salva no estado)
- [ ] Botão "Fechar como Ganho/Perdido"

### AC-404.9: Responsividade
- [ ] Desktop: 5 colunas lado a lado
- [ ] Tablet: Scroll horizontal
- [ ] Mobile: Scroll vertical por estágio

---

## Scope

### IN
- Pipeline 5 estágios
- Drag & drop (react-beautiful-dnd)
- Lead cards + detalhes
- Meta tracking
- Mock data (20+ leads)

### OUT
- Real-time sync com Supabase
- Analytics avançadas
- Forecast inteligente
- Integração com email/SMS
- Relatórios em PDF

---

## Technical Notes

### Dependencies
- **react-beautiful-dnd:** Instalar em npm (3.13.0+)
- **Recharts:** Já instalado

### Data Structure
```typescript
interface SalesLead {
  id: string;
  name: string;
  company?: string;
  email?: string;
  phone?: string;
  stage: 'prospecting' | 'qualification' | 'proposal' | 'negotiation' | 'closed_won' | 'closed_lost';
  value: number;
  probability: number; // 0-100
  source?: string;
  notes?: string;
  next_action_date?: string;
  created_at: string;
}

interface SalesGoal {
  month: Date;
  target_value: number;
}
```

### Components
```
SalesDashboard.tsx
├── PipelineContainer
├── PipelineStage (x5)
│   ├── LeadCard (draggable)
│   ├── StageHeader (title, count, value)
│   └── DropZone
├── MetaTracker
├── ConversionChart
└── NewLeadForm
```

### State Management
- VirtualOfficeContext para leads
- Local state para drag feedback
- useCallback para handlers otimizados

---

## Dependencies

**Depends On:** US-402 (Modal)
**Blocks:** None

---

## Definition of Done

- [x] Drag & drop smooth
- [x] All AC passed
- [x] Performance optimized (virtualization se > 100 leads)
- [x] Mobile tested
- [x] Accessibility: keyboard navigation de leads, labels ARIA
- [x] Tests: 80%+ coverage
- [x] Zero console errors

---

## File List

- [ ] src/components/corporate/dashboards/SalesDashboard.tsx
- [ ] src/components/corporate/dashboards/pipeline/PipelineStage.tsx
- [ ] src/components/corporate/dashboards/pipeline/LeadCard.tsx
- [ ] src/components/corporate/dashboards/forms/NewLeadForm.tsx
- [ ] src/data/salesData.ts
- [ ] src/__tests__/salesDashboard.test.ts

---

## Points Breakdown

- Setup + components: 2.5 pts
- Drag & drop integration: 2.5 pts
- Forms + state: 1.5 pts
- Charts + tracking: 1 pt
- Responsivity + tests: 0.5 pts

---

## Change Log

- **2026-02-17:** Created
