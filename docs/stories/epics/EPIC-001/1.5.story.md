# 1.5: Integrar Envio por WhatsApp

**Status:** Ready
**Sprint:** 4
**Points:** 5
**Epic:** EPIC-001

---

## User Story

**Como** planejador financeiro
**Quero** enviar atas via WhatsApp
**Para que** o cliente receba no canal que mais usa

---

## Description

Implementar integra√ß√£o de envio de atas por WhatsApp usando deep links, com suporte a n√∫meros nacionais e internacionais, formata√ß√£o para texto plano e registro no hist√≥rico.

---

## Acceptance Criteria

### AC-005.1: Bot√£o "Enviar por WhatsApp"
- [ ] Bot√£o vis√≠vel na tela de preview
- [ ] √çcone WhatsApp
- [ ] Desabilitado se telefone inv√°lido

### AC-005.2: Telefone Pr√©-Populado
- [ ] Telefone do cliente pr√©-preenchido
- [ ] Campo edit√°vel
- [ ] Valida√ß√£o: 10-15 d√≠gitos
- [ ] Formato: +55 11 99999-9999
- [ ] Mensagem de erro clara

### AC-005.3: Ata Formatada para Texto Plano
- [ ] Ata convertida de HTML para texto
- [ ] Emojis preservados
- [ ] Line breaks mantidos
- [ ] Sem tags HTML
- [ ] M√°ximo 4096 caracteres

### AC-005.4: Deep Link WhatsApp
- [ ] Abre WhatsApp Web/App
- [ ] Mensagem pr√©-preenchida
- [ ] Formato: https://wa.me/{phone}?text={message}
- [ ] URL encoding correto
- [ ] Suporte a m√∫ltiplas plataformas

### AC-005.5: Registro no Hist√≥rico
- [ ] Ata salva no hist√≥rico ap√≥s envio
- [ ] Campos: id, user_id, client_id, type, channel, recipient, sent_at
- [ ] Recuper√°vel para reenvio
- [ ] Sem duplicatas

### AC-005.6: Suporte a N√∫meros BR e Internacionais
- [ ] BR: (11) 99999-9999 ‚Üí 5511999999999
- [ ] Internacional: +1 2125551234 ‚Üí 12125551234
- [ ] Valida√ß√£o por pa√≠s
- [ ] Tratamento de c√≥digos de pa√≠s

---

## Scope

### IN (Inclu√≠do)
- Deep link WhatsApp
- Telefone pr√©-populado
- Formata√ß√£o para texto plano
- Suporte BR e internacional
- Registro em hist√≥rico
- Valida√ß√£o de telefone

### OUT (N√£o Inclu√≠do)
- Integra√ß√£o WhatsApp Business API
- Confirma√ß√£o de entrega
- Chatbot responses
- Media (imagens/PDFs)

---

## Technical Notes

### Implementation Approach

1. **Service**
   - `whatsappService.ts` (NEW) - l√≥gica de formata√ß√£o e deep link
   - `phoneValidator.ts` (NEW) - valida√ß√£o por pa√≠s

2. **Components**
   - `SendWhatsAppModal.tsx` (NEW) - modal completo
   - `PhoneInput.tsx` - componente reutiliz√°vel
   - `TextPreview.tsx` - preview do texto

3. **Phone Validation Library**
   - libphonenumber-js (leve, sem depend√™ncias nativas)

4. **File Structure**
```
src/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ whatsappService.ts (NEW)
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ phoneValidator.ts (NEW)
‚îî‚îÄ‚îÄ components/
    ‚îî‚îÄ‚îÄ crm/
        ‚îî‚îÄ‚îÄ whatsapp/
            ‚îú‚îÄ‚îÄ SendWhatsAppModal.tsx (NEW)
            ‚îî‚îÄ‚îÄ TextPreview.tsx (NEW)
```

### Deep Link Implementation
```typescript
function generateWhatsAppLink(phone: string, message: string): string {
  const cleanPhone = phone.replace(/\D/g, '');
  const msg = encodeURIComponent(message);
  return `https://wa.me/${cleanPhone}?text=${msg}`;
}

function sendViaWhatsApp(phone: string, message: string) {
  const url = generateWhatsAppLink(phone, message);
  window.open(url, '_blank', 'width=800,height=600');

  // Registrar no hist√≥rico
  saveToHistory({
    type: 'whatsapp',
    recipient: phone,
    content: message,
    sent_at: new Date()
  });
}
```

### Text Formatting
```typescript
function formatAtaToPlainText(ata: MeetingMinutes): string {
  return `
üìù ATA DE REUNI√ÉO

üë§ Cliente: ${ata.client_name}
üìÖ Data: ${formatDate(ata.meeting_date)}

üìå Pr√≥xima Reuni√£o
${formatDate(ata.next_meeting_date)} √†s ${ata.next_meeting_time}

üìù T√≥picos Discutidos
${ata.topics.map(t => `‚Ä¢ ${t}`).join('\n')}

üìå Pontos Pendentes
${ata.pending_items.map(p => `‚Ä¢ ${p}`).join('\n')}

üìö Materiais Recomendados
${ata.materials.map(m => `‚Ä¢ ${m}`).join('\n')}

Qualquer d√∫vida, estou por aqui! üëäüìà
  `.trim();
}
```

---

## Definition of Done

- [ ] Service de WhatsApp implementado
- [ ] Modal funcional
- [ ] Telefone validado
- [ ] Deep link funcionando
- [ ] Abre WhatsApp corretamente
- [ ] Hist√≥rico registrando
- [ ] Suporte BR e internacional
- [ ] Text preview correto
- [ ] Responsive design
- [ ] Testes unit√°rios
- [ ] Sem console errors
- [ ] Commit e PR criado

---

## Dependencies

**Blocks:** None (US-108 usa dados)

**Depends On:** US-102, US-103 (atas)

---

## Business Value

**M√©dio** - Envio em canal preferido dos clientes

---

## Risks

| Risk | Mitigation |
|------|-----------|
| WhatsApp bloqueia deep links | Fallback: copiar texto para clipboard |
| Limite de caracteres | Avisar usu√°rio se > 4096 chars |
| Telefone inv√°lido | Valida√ß√£o robusta com libphonenumber |

---

## File List

- [ ] src/services/whatsappService.ts
- [ ] src/utils/phoneValidator.ts
- [ ] src/components/crm/whatsapp/SendWhatsAppModal.tsx
- [ ] src/components/crm/whatsapp/TextPreview.tsx

---

## Change Log

- **2026-02-17:** Story created (US-105)
- **2026-02-17:** @po validated - VERDICT: GO (10/10 checklist)
- **Status:** Ready for development

