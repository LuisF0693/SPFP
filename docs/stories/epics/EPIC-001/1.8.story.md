# 1.8: Implementar Histórico de Atas Enviadas

**Status:** Ready
**Sprint:** 4
**Points:** 5
**Epic:** EPIC-001

---

## User Story

**Como** planejador financeiro
**Quero** ver o histórico de todas as atas que enviei para um cliente
**Para que** eu tenha contexto das conversas anteriores e possa reenviar se necessário

---

## Description

Implementar aba "Histórico" no perfil do cliente mostrando lista de todas as atas enviadas com data, tipo, canal de envio, visualização da ata original, reenvio e filtros por tipo/canal.

---

## Acceptance Criteria

### AC-008.1: Aba "Histórico" no Perfil do Cliente
- [ ] Menu: Resumo | Atas | Arquivos | Histórico
- [ ] Aba carrega corretamente
- [ ] Mostra atas daquele cliente apenas
- [ ] Sem lag ao alternar

### AC-008.2: Lista de Atas Enviadas
- [ ] Exibe: data, tipo (reunião/investimentos), canal (email/whatsapp)
- [ ] Linha por ata com ações
- [ ] Ordem: mais recente primeiro
- [ ] Formatação clara e legível

### AC-008.3: Visualizar Ata Enviada
- [ ] Botão "Ver" ou click na linha
- [ ] Abre modal com ata renderizada
- [ ] Mostra dados originais
- [ ] Botão de fechar modal

### AC-008.4: Reenviar Ata Existente
- [ ] Botão "Reenviar" em cada ata
- [ ] Abre diálogo com opções: Email / WhatsApp
- [ ] Email: pré-populado, editável
- [ ] WhatsApp: telefone pré-populado, editável
- [ ] Registro como novo envio

### AC-008.5: Filtrar por Tipo
- [ ] Dropdown: Todos | Reunião | Investimentos
- [ ] Filtra lista em tempo real
- [ ] Mostra contagem por tipo

### AC-008.6: Filtrar por Canal
- [ ] Dropdown: Todos | Email | WhatsApp
- [ ] Filtra lista em tempo real
- [ ] Mostra contagem por canal

### AC-008.7: Ordenar por Data
- [ ] Padrão: mais recente primeiro (descendente)
- [ ] Botão toggle: ascendente/descendente
- [ ] Ícone de ordenação clara

---

## Scope

### IN (Incluído)
- Aba histórico
- Lista de atas enviadas
- Visualizar ata
- Reenviar ata
- Filtros por tipo
- Filtros por canal
- Ordenação por data

### OUT (Não Incluído)
- Editar ata histórica (copiar para nova é alternativa)
- Deletar histórico
- Exportar histórico
- Métricas de engajamento

---

## Technical Notes

### Implementation Approach

1. **Components**
   - `HistoryTab.tsx` (NEW) - container principal
   - `MinutesHistoryList.tsx` (NEW) - lista de atas
   - `HistoryItem.tsx` (NEW) - item individual
   - `HistoryFilters.tsx` (NEW) - filtros e ordenação
   - `HistoryViewer.tsx` (NEW) - modal de visualização

2. **Data Structure**
```typescript
interface SentAta {
  id: string;
  user_id: string;
  client_id: string;
  client_name: string;
  type: 'reuniao' | 'investimentos';
  channel: 'email' | 'whatsapp';
  content: string;
  recipient: string; // email ou telefone
  sent_at: Date;
  created_at: Date;
}
```

3. **Services**
   - `historyService.ts` (NEW) - CRUD de histórico
   - Usa dados de `sent_atas` table (já existe)

4. **File Structure**
```
src/
├── services/
│   └── historyService.ts (NEW)
└── components/
    └── crm/
        └── history/
            ├── HistoryTab.tsx (NEW)
            ├── MinutesHistoryList.tsx (NEW)
            ├── HistoryItem.tsx (NEW)
            ├── HistoryFilters.tsx (NEW)
            └── HistoryViewer.tsx (NEW)
```

### Filter State
```typescript
interface HistoryFilter {
  typeFilter: 'all' | 'reuniao' | 'investimentos';
  channelFilter: 'all' | 'email' | 'whatsapp';
  sortOrder: 'desc' | 'asc';
}

// Computed
const filtered = atas
  .filter(a => typeFilter === 'all' || a.type === typeFilter)
  .filter(a => channelFilter === 'all' || a.channel === channelFilter)
  .sort((a, b) => {
    const aTime = new Date(a.sent_at).getTime();
    const bTime = new Date(b.sent_at).getTime();
    return sortOrder === 'desc' ? bTime - aTime : aTime - bTime;
  });
```

### Resend Implementation
```typescript
async function resendViaEmail(ata: SentAta, newRecipient: string) {
  // Enviar
  await emailService.send({
    to: newRecipient,
    subject: `Ata de ${ata.type === 'reuniao' ? 'Reunião' : 'Investimentos'}`,
    html: ata.content
  });

  // Registrar novo envio
  await historyService.create({
    ...ata,
    id: undefined, // nova ID
    recipient: newRecipient,
    sent_at: new Date()
  });
}
```

---

## Definition of Done

- [ ] Aba histórico funcional
- [ ] Lista de atas carregando
- [ ] Visualização de ata funcionando
- [ ] Reenvio funcional (email + whatsapp)
- [ ] Filtros por tipo e canal
- [ ] Ordenação por data
- [ ] Responsive design
- [ ] Testes unitários
- [ ] Sem console errors
- [ ] Commit e PR criado

---

## Dependencies

**Blocks:** None

**Depends On:** US-102, US-103, US-104, US-105 (depend disso para reenviar)

---

## Business Value

**Médio** - Melhora contexto de clientes e reutilização

---

## Risks

| Risk | Mitigation |
|------|-----------|
| Muitos registros (slow query) | Paginar em 50, index em sent_at |
| Ata renderizada incorreta | Use conteúdo original armazenado |
| Reenvio duplica registro | Unique constraint + idempotência |

---

## File List

- [x] src/services/historyService.ts
- [x] src/components/crm/history/HistoryTab.tsx
- [ ] src/components/crm/history/MinutesHistoryList.tsx
- [ ] src/components/crm/history/HistoryItem.tsx
- [ ] src/components/crm/history/HistoryFilters.tsx
- [ ] src/components/crm/history/HistoryViewer.tsx

---

## Change Log

- **2026-02-17:** Story created (US-108)
- **2026-02-17:** @po validated - VERDICT: GO (10/10 checklist)
- **Status:** Ready for development

