# 1.3: Criar Sistema de Atas de Investimentos

**Status:** Ready
**Sprint:** 3
**Points:** 13
**Epic:** EPIC-001

---

## User Story

**Como** planejador financeiro
**Quero** criar recomendações de investimentos formatadas profissionalmente
**Para que** meu cliente tenha um registro claro da alocação recomendada

---

## Description

Implementar sistema de criação de atas de investimentos com suporte a múltiplas classes de ativos (Ações, FIIs, Internacionais, Renda Fixa, Cripto), cálculo automático de totais e percentuais, resumo consolidado e preview formatado.

---

## Acceptance Criteria

### AC-003.1: Botão "Nova Ata de Investimentos"
- [ ] Botão visível no perfil do cliente
- [ ] Abre modal com formulário
- [ ] Foco automático no primeiro campo

### AC-003.2: Campos Principais
- [ ] Campo: Data (date picker)
- [ ] Campo: Cliente (pré-populado)
- [ ] Campo: Objetivo/Perfil (ex: "Agressivo", "Moderado")
- [ ] Validação: campos obrigatórios

### AC-003.3: Seção por Classe de Ativo
- [ ] 5 seções: Ações, FIIs, Internacional, RF, Cripto
- [ ] Cada seção expandível/retrátil
- [ ] Botão "+Adicionar Ativo" por seção
- [ ] Reorder com drag & drop

### AC-003.4: Linha por Ativo
- [ ] Campos: Ticker, Nome, Valor Unitário, Quantidade
- [ ] Campos com validação numérica
- [ ] Cálculo automático: Total = Valor × Quantidade
- [ ] Deletar linha com confirmação

### AC-003.5: Cálculo Automático de Totais
- [ ] Total por classe (soma de todos os ativos)
- [ ] Renderiza em tempo real
- [ ] Formato: R$ 1.234,56

### AC-003.6: Cálculo Automático de Percentuais
- [ ] % do total para cada classe
- [ ] Atualize em tempo real
- [ ] Soma deve ser 100%
- [ ] Formato: 25,50%

### AC-003.7: Resumo Consolidado
- [ ] Seção final com resumo
- [ ] Total geral em destaque
- [ ] Alocação por classe em percentual
- [ ] Maior exposição destacada

### AC-003.8: Campo de Notas
- [ ] Campo livre para próximos passos
- [ ] Rich text: bold, italic, lista
- [ ] Emojis suportados

### AC-003.9: Preview Formatado
- [ ] Botão "Preview"
- [ ] Ata formatada como será enviada
- [ ] Editar e voltar ao editor
- [ ] Sem erros de cálculo

---

## Scope

### IN (Incluído)
- Formulário de nova ata investimentos
- 5 classes de ativos
- Cálculo automático totais/percentuais
- Resumo consolidado
- Preview formatado
- Campo de notas

### OUT (Não Incluído)
- Integração Email (vem em US-104)
- Integração WhatsApp (vem em US-105)
- Histórico (vem em US-108)
- Templates customizáveis (vem em US-106)
- Análise de performance de ativos

---

## Technical Notes

### Implementation Approach

1. **Components**
   - `InvestmentMinutesForm.tsx` (NEW) - formulário principal
   - `AssetClassSection.tsx` (NEW) - seção por classe
   - `AssetRow.tsx` (NEW) - linha individual de ativo
   - `InvestmentSummary.tsx` (NEW) - resumo consolidado
   - `InvestmentPreview.tsx` (NEW) - preview

2. **Data Structure**
```typescript
interface InvestmentMinutes {
  id: string;
  client_id: string;
  client_name: string;
  date: Date;
  objective: string;
  assets: {
    class: 'acoes' | 'fiis' | 'internacional' | 'rf' | 'cripto';
    items: AssetItem[];
  }[];
  notes: string;
  total_value: number;
  allocations: Record<string, number>; // percentuais
}

interface AssetItem {
  id: string;
  ticker: string;
  name: string;
  unit_value: number;
  quantity: number;
  total: number; // calculated
}
```

3. **Calculations Engine**
```typescript
// Cálculos automáticos
function calculateAssetTotal(asset: AssetItem) {
  return asset.unit_value * asset.quantity;
}

function calculateClassTotal(assets: AssetItem[]) {
  return assets.reduce((sum, a) => sum + calculateAssetTotal(a), 0);
}

function calculateAllocation(classTotal: number, total: number) {
  return (classTotal / total) * 100;
}
```

4. **File Structure**
```
src/components/
├── crm/
│   ├── investments/
│   │   ├── InvestmentMinutesForm.tsx (NEW)
│   │   ├── AssetClassSection.tsx (NEW)
│   │   ├── AssetRow.tsx (NEW)
│   │   ├── InvestmentSummary.tsx (NEW)
│   │   └── InvestmentPreview.tsx (NEW)
```

---

## Definition of Done

- [ ] Formulário completo funcional
- [ ] 5 classes de ativos implementadas
- [ ] Cálculos automáticos corretos
- [ ] Preview renderiza corretamente
- [ ] Validações funcionando
- [ ] Responsive (mobile/tablet/desktop)
- [ ] Testes unitários para cálculos
- [ ] Sem console errors
- [ ] Commit e PR criado

---

## Dependencies

**Blocks:** US-104 (Email), US-105 (WhatsApp), US-108 (Histórico)

**Depends On:** US-101 (UI modernizada)

---

## Business Value

**Alto** - Feature essencial para planejadores de investimentos

---

## Risks

| Risk | Mitigation |
|------|-----------|
| Erros de cálculo | Testes unitários rigorosos |
| UX complexa | Design limpo, seções expandíveis |
| Performance com muitos ativos | Max 100 ativos por ata |

---

## File List

- [x] src/components/crm/investments/InvestmentMinutesForm.tsx
- [ ] src/components/crm/investments/AssetClassSection.tsx
- [x] src/components/crm/investments/AssetRow.tsx
- [ ] src/components/crm/investments/InvestmentSummary.tsx
- [ ] src/components/crm/investments/InvestmentPreview.tsx

---

## Change Log

- **2026-02-17:** Story created (US-103)
- **2026-02-17:** @po validated - VERDICT: GO (10/10 checklist)
- **Status:** Ready for development

