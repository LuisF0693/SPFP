# 1.7: Implementar Aba de Arquivos/Slides

**Status:** Draft
**Sprint:** 4
**Points:** 13
**Epic:** EPIC-001

---

## User Story

**Como** planejador financeiro
**Quero** organizar meus slides e documentos em um lugar centralizado
**Para que** eu encontre rapidamente durante reuniões

---

## Description

Implementar sistema de gestão de arquivos com upload via drag & drop, categorização automática, visualizador inline para PDFs, busca e filtros avançados, armazenamento em Supabase Storage.

---

## Acceptance Criteria

### AC-007.1: Nova Aba "Arquivos"
- [ ] Menu CRM: Resumo | Atas | Arquivos | Timeline
- [ ] Aba carrega corretamente
- [ ] Persiste seleção ao navegar
- [ ] Sem lag ao alternar

### AC-007.2: Upload via Drag & Drop ou Botão
- [ ] Drag & drop area visível
- [ ] Botão "Selecionar Arquivo"
- [ ] Progress bar durante upload
- [ ] Múltiplos uploads simultâneos

### AC-007.3: Tipos Suportados
- [ ] PDF, PPT, PPTX, PNG, JPG, JPEG
- [ ] Ícones diferentes por tipo
- [ ] Validação no frontend + backend
- [ ] Erro claro se tipo inválido

### AC-007.4: Limite de Tamanho
- [ ] Máximo 10MB por arquivo
- [ ] Validação antes de enviar
- [ ] Mensagem de erro se exceder
- [ ] Progress bar mostra percentual

### AC-007.5: Categorias
- [ ] 4 categorias: Investimentos, Planejamento, Educacional, Outros
- [ ] Auto-classificação por tipo
- [ ] Permitir reclassificar
- [ ] Exibir quantidade por categoria

### AC-007.6: Visualizador Inline para PDF
- [ ] Componente react-pdf integrado
- [ ] Abrir PDF em modal
- [ ] Navbar: primeira página, última página, número de página
- [ ] Zoom in/out
- [ ] Download direto

### AC-007.7: Favoritar Arquivos
- [ ] Ícone estrela em cada arquivo
- [ ] Click para marcar/desmarcar
- [ ] Seção "⭐ Favoritos" no topo
- [ ] Persist em database

### AC-007.8: Busca por Nome
- [ ] Campo de busca no topo
- [ ] Busca em tempo real (debounce 300ms)
- [ ] Destaque do termo encontrado
- [ ] Case-insensitive

### AC-007.9: Ordenar por Data, Nome, Categoria
- [ ] Dropdown "Ordenar por..."
- [ ] Opções: Data (desc), Nome (A-Z), Categoria
- [ ] Seta para ascendente/descendente
- [ ] Persist na sessão

### AC-007.10: Excluir Arquivo
- [ ] Botão delete em cada arquivo
- [ ] Confirmação: "Tem certeza?"
- [ ] Remover de Storage e database
- [ ] Mensagem de sucesso

---

## Scope

### IN (Incluído)
- Upload drag & drop
- Tipagem e validação
- Categorização
- Favoritos
- Busca
- Filtros e ordenação
- Visualizador PDF
- Exclusão com confirmação
- Armazenamento Supabase

### OUT (Não Incluído)
- Versionamento de arquivos
- Compartilhamento com cliente
- Integração com Google Drive/OneDrive
- Scan/OCR de documentos
- Comentários em arquivos

---

## Technical Notes

### Implementation Approach

1. **Components**
   - `FileManager.tsx` (NEW) - container principal
   - `FileUploadZone.tsx` (NEW) - drag & drop
   - `FileList.tsx` (NEW) - lista/grid
   - `FileItem.tsx` (NEW) - item individual
   - `PDFViewer.tsx` (NEW) - modal PDF
   - `FileFilters.tsx` (NEW) - busca/ordenação

2. **Data Structure**
```typescript
interface UserFile {
  id: string;
  user_id: string;
  name: string;
  category: 'investimentos' | 'planejamento' | 'educacional' | 'outros';
  storage_path: string; // bucket/user_id/category/filename
  size_bytes: number;
  mime_type: string;
  is_favorite: boolean;
  created_at: Date;
}
```

3. **Services**
   - `fileService.ts` (NEW) - CRUD files
   - `storageService.ts` (NEW) - Supabase Storage upload
   - `fileValidator.ts` (NEW) - validação tipo/tamanho

4. **Libraries**
   - react-pdf (visualizador)
   - react-dropzone (drag & drop)
   - date-fns (formatação)

5. **File Structure**
```
src/
├── services/
│   ├── fileService.ts (NEW)
│   ├── storageService.ts (NEW)
│   └── fileValidator.ts (NEW)
└── components/
    └── crm/
        └── files/
            ├── FileManager.tsx (NEW)
            ├── FileUploadZone.tsx (NEW)
            ├── FileList.tsx (NEW)
            ├── FileItem.tsx (NEW)
            ├── PDFViewer.tsx (NEW)
            └── FileFilters.tsx (NEW)
```

### Supabase Storage Structure
```
bucket: spfp-files
├── {user_id}/
│   ├── investimentos/
│   │   ├── carteira-recomendada.pdf
│   │   └── analise-fiis.pdf
│   ├── planejamento/
│   │   └── guia-planejamento.pdf
│   ├── educacional/
│   │   └── aula-investimentos.pdf
│   └── outros/
│       └── documento.docx
```

### Upload Implementation
```typescript
async function uploadFile(file: File, category: string): Promise<UserFile> {
  // Validar
  const error = validateFile(file);
  if (error) throw new Error(error);

  const fileName = `${Date.now()}-${file.name}`;
  const path = `${userId}/${category}/${fileName}`;

  // Upload
  const { data, error: uploadError } = await supabase.storage
    .from('spfp-files')
    .upload(path, file);

  if (uploadError) throw uploadError;

  // Registrar no banco
  const fileRecord = await fileService.create({
    user_id: userId,
    name: file.name,
    category,
    storage_path: path,
    size_bytes: file.size,
    mime_type: file.type,
    is_favorite: false
  });

  return fileRecord;
}
```

---

## Definition of Done

- [ ] Upload funcional (drag & drop + botão)
- [ ] Validação de tipo e tamanho
- [ ] Categorização automática
- [ ] Favoritos funcionando
- [ ] Busca em tempo real
- [ ] Filtros e ordenação
- [ ] PDF viewer funcional
- [ ] Exclusão com confirmação
- [ ] Storage Supabase integrado
- [ ] Responsive (mobile/tablet/desktop)
- [ ] Testes unitários
- [ ] Sem console errors
- [ ] Commit e PR criado

---

## Dependencies

**Blocks:** None

**Depends On:** US-101 (UI modernizada)

---

## Business Value

**Médio** - Melhora organização e produtividade

---

## Risks

| Risk | Mitigation |
|------|-----------|
| Upload lento (WiFi fraco) | Progress bar, timeout 30s, retry |
| Storage cheio rápido | Quota 500MB, alertar em 80% |
| PDF viewer lag | Lazy load, virtualization se muitos |

---

## File List

- [ ] src/services/fileService.ts
- [ ] src/services/storageService.ts
- [ ] src/services/fileValidator.ts
- [ ] src/components/crm/files/FileManager.tsx
- [ ] src/components/crm/files/FileUploadZone.tsx
- [ ] src/components/crm/files/FileList.tsx
- [ ] src/components/crm/files/FileItem.tsx
- [ ] src/components/crm/files/PDFViewer.tsx
- [ ] src/components/crm/files/FileFilters.tsx

---

## Change Log

- **2026-02-17:** Story created (US-107)
- **Status:** Draft for validation

