# 1.4: Integrar Envio por Email

**Status:** Draft
**Sprint:** 4
**Points:** 8
**Epic:** EPIC-001

---

## User Story

**Como** planejador financeiro
**Quero** enviar atas diretamente pelo email do cliente
**Para que** ele receba no canal mais profissional

---

## Description

Implementar integração de envio de atas (reunião e investimentos) por email usando API Resend, com preview antes do envio, confirmação de entrega e registro no histórico.

---

## Acceptance Criteria

### AC-004.1: Botão "Enviar por Email"
- [ ] Botão visível na tela de preview
- [ ] Abre modal de envio
- [ ] Desabilitado se email inválido

### AC-004.2: Email Pré-Populado
- [ ] Email do cliente pré-preenchido
- [ ] Campo editável
- [ ] Validação de email
- [ ] Mensagem de erro clara

### AC-004.3: Assunto Personalizável
- [ ] Campo: Assunto do Email
- [ ] Valor padrão: "Ata de Reunião - {cliente} - {data}"
- [ ] Suporte a variáveis: {cliente}, {data}, {type}
- [ ] Máximo 100 caracteres

### AC-004.4: Corpo do Email
- [ ] Ata formatada em HTML
- [ ] Template profissional com logo/header
- [ ] Cores e tipografia consistentes
- [ ] Rodapé com assinatura do planejador

### AC-004.5: Confirmação Antes de Enviar
- [ ] Modal de confirmação
- [ ] Mostra: para quem, assunto, preview
- [ ] Botões: "Enviar" e "Cancelar"
- [ ] Checkbox: "Não mostrar novamente"

### AC-004.6: Feedback de Sucesso/Erro
- [ ] Toast notificação de sucesso
- [ ] Mensagem: "Email enviado para {email}"
- [ ] Toast erro com motivo se falhar
- [ ] Retry automático em caso de timeout (max 3x)

### AC-004.7: Registro no Histórico
- [ ] Ata salva no histórico após envio
- [ ] Campos: id, user_id, client_id, type, channel, recipient, sent_at
- [ ] Recuperável para reenvio
- [ ] Sem duplicatas

---

## Scope

### IN (Incluído)
- Integração Resend API
- Modal de envio
- Email pré-populado
- Assunto personalizável
- Confirmação antes enviar
- Feedback sucesso/erro
- Registro em histórico

### OUT (Não Incluído)
- Attachments (vem em US-107)
- Templates customizáveis (vem em US-106)
- Tracking de abertura
- Agendamento de envio

---

## Technical Notes

### Implementation Approach

1. **Service**
   - `emailService.ts` (NEW) - wrapper Resend API
   - `useEmail.ts` hook (NEW) - state e lógica

2. **Components**
   - `SendEmailModal.tsx` (NEW) - modal completo
   - `EmailPreview.tsx` (NEW) - preview HTML
   - `SendConfirmation.tsx` (NEW) - confirmação

3. **Integrações**
   - Resend API (criar free account)
   - Supabase: table `sent_atas` (já existe)

4. **Environment**
```
VITE_RESEND_API_KEY=re_xxxxx
```

5. **File Structure**
```
src/
├── services/
│   └── emailService.ts (NEW)
├── hooks/
│   └── useEmail.ts (NEW)
└── components/
    └── crm/
        └── email/
            ├── SendEmailModal.tsx (NEW)
            ├── EmailPreview.tsx (NEW)
            └── SendConfirmation.tsx (NEW)
```

### Email Template
```html
<div style="font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px;">
  <div style="max-width: 600px; margin: 0 auto; background: white; border-radius: 8px; padding: 20px;">
    <!-- Header -->
    <div style="border-bottom: 2px solid #6366F1; margin-bottom: 20px; padding-bottom: 20px;">
      <h1 style="margin: 0; color: #1a1f2e;">Ata da Reunião</h1>
    </div>

    <!-- Content (ata renderizada) -->
    <div style="margin-bottom: 30px;">
      {ata_content_aqui}
    </div>

    <!-- Footer -->
    <div style="border-top: 1px solid #e0e0e0; padding-top: 20px; margin-top: 20px; color: #666; font-size: 12px;">
      <p>{planejador_nome}</p>
      <p>{planejador_email} | {planejador_telefone}</p>
    </div>
  </div>
</div>
```

---

## Definition of Done

- [ ] Resend API integrada
- [ ] Modal funcional
- [ ] Email validação
- [ ] Envio funcionando
- [ ] Histórico registrando
- [ ] Feedback sucesso/erro
- [ ] Retry automático
- [ ] Responsive design
- [ ] Testes unitários
- [ ] Sem console errors
- [ ] Commit e PR criado

---

## Dependencies

**Blocks:** None (US-108 usa dados)

**Depends On:** US-102, US-103 (atas)

---

## Business Value

**Médio/Alto** - Automatiza envio profissional

---

## Risks

| Risk | Mitigation |
|------|-----------|
| API rate limit | Resend free: 100 emails/dia (suficiente) |
| Email deliverability | Setup SPF/DKIM em domínio |
| HTML rendering | Test em Gmail, Outlook, Apple Mail |

---

## File List

- [ ] src/services/emailService.ts
- [ ] src/hooks/useEmail.ts
- [ ] src/components/crm/email/SendEmailModal.tsx
- [ ] src/components/crm/email/EmailPreview.tsx
- [ ] src/components/crm/email/SendConfirmation.tsx

---

## Change Log

- **2026-02-17:** Story created (US-104)
- **Status:** Draft for validation

