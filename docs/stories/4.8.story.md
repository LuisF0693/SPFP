# 4.8: Gates de Aprovação

**Status:** Ready
**Sprint:** 7-8
**Points:** 5
**Epic:** EPIC-004

---

## User Story

**Como** empresário
**Quero** aprovar/rejeitar atividades que requerem aprovação
**Para que** eu tenha controle sobre processos críticos

---

## Description

Implementar sistema de gates/approval gates onde:
- Atividades que requerem aprovação mostram botões Aprovar/Rejeitar
- Clique salva decisão com timestamp + quem aprovou
- Atividade muda de status após aprovação
- Histórico de aprovações rastreado
- Notificação visual após ação

---

## Acceptance Criteria

### AC-408.1: Gate Badge no Feed
- [ ] Atividades com `requires_approval: true` mostram gate badge
- [ ] Badge: "⏳ AWAITING APPROVAL"
- [ ] Cor: Âmbar (#F59E0B)
- [ ] Clique abre modal de aprovação

### AC-408.2: Modal de Aprovação
- [ ] Mostra detalhes da atividade
- [ ] 2 botões: ✅ Aprovar | ❌ Rejeitar
- [ ] Botão Aprovar: verde
- [ ] Botão Rejeitar: vermelho (pede motivo)

### AC-408.3: Rejeição com Motivo
- [ ] Clique em Rejeitar abre campo de texto
- [ ] Espaço para motivo (150 caracteres)
- [ ] Salva motivo com rejeição
- [ ] Status muda para "REJECTED"

### AC-408.4: Aprovação
- [ ] Clique em Aprovar marca como aprovado
- [ ] Status muda para "COMPLETED" ou "APPROVED"
- [ ] Timestamp + user ID salvo
- [ ] Visual feedback: checkmark animado

### AC-408.5: Histórico de Aprovações
- [ ] Cada atividade rastreia: approved_by, approved_at, rejection_reason
- [ ] Histórico visível na expansão da atividade
- [ ] Mostra: "Aprovado por {nome} em {data}"

### AC-408.6: Notificação
- [ ] Toast ou badge no card dizendo "Aprovado!" ou "Rejeitado"
- [ ] Desaparece após 3s
- [ ] Cor verde para aprovado, vermelha para rejeitado

### AC-408.7: Sem Duplicatas de Aprovação
- [ ] Uma vez aprovado/rejeitado, não pode ser alterado
- [ ] Botões desabilitados após ação
- [ ] Feedback visual (disabled state)

---

## Scope

### IN
- Modal de aprovação
- Botões Aprovar/Rejeitar
- Motivo de rejeição
- Histórico
- Notificações
- State updates

### OUT
- Email notifications
- Webhook para sistema externo
- Analytics de aprovações
- Bulk approvals
- Delegation de aprovações

---

## Technical Notes

### Data Extension
```typescript
interface ActivityFeedItem {
  // ... existing fields ...
  approved_by?: string; // user_id
  approved_at?: string; // timestamp
  rejection_reason?: string;
}
```

### Components
```
ApprovalGate.tsx (modal)
├── ActivityDetails
├── ApproveButton
├── RejectButton (opens textfield)
└── HistoryFooter
```

### State Updates
- Após aprovação: `updateActivity(id, { approved_by, approved_at, status: 'completed' })`
- Após rejeição: `updateActivity(id, { rejected_by, rejected_at, rejection_reason, status: 'rejected' })`

### Toast Notifications
- Use existing toast library (ou Sonner, Toastify)
- Duration: 3s
- Position: top-right

---

## Dependencies

**Depends On:** US-407 (Feed items)
**Blocks:** None

---

## Definition of Done

- [x] Approval modal works
- [x] All AC passed
- [x] Buttons functional
- [x] State updates correctly
- [x] Notifications show
- [x] History tracked
- [x] No console errors
- [x] Mobile friendly

---

## File List

- [ ] src/components/corporate/gates/ApprovalGate.tsx
- [ ] src/components/corporate/feed/ActivityCard.tsx (update)
- [ ] src/__tests__/approvalGate.test.ts

---

## Points Breakdown

- Modal: 1.5 pts
- Buttons + state: 1.5 pts
- Notifications: 1 pt
- History: 0.5 pts
- Tests: 0.5 pts

---

## Change Log

- **2026-02-17:** Created
